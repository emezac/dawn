# PlanToTasksHandler

## Overview

The `PlanToTasksHandler` is a critical component in the Chat Planner Workflow that serves as the bridge between the validated plan (generated by an LLM and validated by the `validate_plan_handler`) and the executable task definitions needed by the workflow engine.

This handler transforms the abstract plan steps into concrete task definitions that the workflow engine can execute, determining the appropriate task types, capturing dependencies, and preserving input data connections.

## Position in Workflow

In the standard Chat Planner Workflow, the `PlanToTasksHandler` sits between:
- The **Plan Validation Phase** (which ensures the plan is structurally valid and logically sound)
- The **Dynamic Task Execution Phase** (which will execute the generated tasks)

## Inputs and Outputs

### Inputs

- **validated_plan**: A JSON array of step objects that has passed validation, containing:
  - `step_id`: Unique identifier for the step
  - `description`: Human-readable description of what the step does
  - `type`: Either "tool" or "handler" indicating the capability type
  - `name`: The specific tool or handler name to execute
  - `inputs`: Key-value pairs for input parameters
  - `depends_on`: Array of step_ids that must complete before this step executes
  - `outputs`: (Optional) Array of expected output fields

### Outputs

- **tasks**: An array of task definition objects containing:
  - `task_id`: Matches the original step_id
  - `name`: Uses the step's description as the task name
  - `input_data`: The original step inputs
  - `depends_on`: Preserved dependency relationships
  - Additional type-specific fields:
    - For tools: `tool_name`, `is_llm_task: false`
    - For handlers: `handler_name`, `task_class: "DirectHandlerTask"`, `is_llm_task: false` 
- **conversion_warnings**: Any warnings generated during the conversion process

## Implementation Details

### Type Mapping

The handler categorizes tasks based on the step type field:

1. **Tool Steps** (`type: "tool"`):
   - Mapped to standard tool tasks
   - `tool_name` is set to the step's `name`
   - `is_llm_task` is set to false

2. **Handler Steps** (`type: "handler"`):
   - Mapped to DirectHandlerTasks
   - `handler_name` is set to the step's `name`
   - `task_class` is set to "DirectHandlerTask"
   - `is_llm_task` is set to false

### Field Preservation

The handler carefully preserves:
- Step IDs (as task_ids)
- Dependency relationships (through the depends_on field)
- Input data structure (maintaining variable references for resolution during execution)
- Descriptive information (using the step description as the task name)

### Error Handling

The handler implements these error handling strategies:

1. **Early Validation**: Checks if the validated_plan is a list before processing
2. **Step-Level Error Isolation**: Processes each step individually in a try/except block
3. **Field Validation**: Skips steps missing critical fields (task_id, type, name)
4. **Type Validation**: Skips steps with unrecognized types

### Common Issues

1. **Missing Fields**: If a step is missing required fields, it will be skipped
2. **Unknown Types**: If a step has a type other than "tool" or "handler", it will be skipped
3. **Empty Plan**: If no valid task definitions can be generated, the handler returns an error

## Usage Example

```python
# Handler invocation (performed by the workflow engine)
result = plan_to_tasks_handler(
    task,
    {
        "validated_plan": [
            {
                "step_id": "step_1",
                "description": "Search for information",
                "type": "tool",
                "name": "web_search",
                "inputs": {"query": "test query"},
                "outputs": ["search_results"],
                "depends_on": []
            },
            {
                "step_id": "step_2",
                "description": "Summarize results",
                "type": "handler",
                "name": "text_summarizer",
                "inputs": {"text": "${step_1.output.search_results}"},
                "outputs": ["summary"],
                "depends_on": ["step_1"]
            }
        ]
    }
)

# Result structure
{
    "success": True,
    "result": {
        "tasks": [
            {
                "task_id": "step_1",
                "name": "Search for information",
                "input_data": {"query": "test query"},
                "depends_on": [],
                "is_llm_task": False,
                "tool_name": "web_search"
            },
            {
                "task_id": "step_2",
                "name": "Summarize results",
                "input_data": {"text": "${step_1.output.search_results}"},
                "depends_on": ["step_1"],
                "is_llm_task": False,
                "handler_name": "text_summarizer",
                "task_class": "DirectHandlerTask"
            }
        ],
        "task_definitions": [/* Same as tasks */],
        "conversion_warnings": []
    }
}
``` 